#!/usr/bin/env bash
# bkp-pendrive - CLI for mounting EXT4 USB drives in WSL2
set -e

# =========================
# Resolve paths (follow symlinks)
# =========================
get_real_path() {
    local path="$1"
    # Follow symlink if it is one
    while [ -L "$path" ]; do
        path=$(readlink "$path")
    done
    echo "$path"
}

REAL_SCRIPT=$(get_real_path "${BASH_SOURCE[0]}")
SCRIPT_DIR="$(cd "$(dirname "$REAL_SCRIPT")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# =========================
# Source libraries
# =========================
source "$PROJECT_ROOT/lib/logging.sh"
source "$PROJECT_ROOT/lib/tui.sh"
source "$PROJECT_ROOT/lib/checks.sh"
source "$PROJECT_ROOT/lib/usbipd.sh"
source "$PROJECT_ROOT/lib/mount_ext4.sh"

# =========================
# Load config
# =========================
CONFIG_FILE="$HOME/.config/bkp-pendrive/config"
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# Defaults
MOUNT_POINT="${MOUNT_POINT:-/mnt/bkp-pendrive}"
PENDRIVE_LABEL="${PENDRIVE_LABEL:-}"
SIMULATE_MODE=false

# =========================
# Version
# =========================
VERSION=$(cat "$PROJECT_ROOT/VERSION" 2>/dev/null || echo "dev")

# =========================
# Help
# =========================
show_help() {
    echo -e "\033[1mbkp-pendrive\033[0m v$VERSION"
    echo
    echo "Ferramenta para montar pendrives EXT4 no WSL2"
    echo
    echo -e "\033[1mUso:\033[0m"
    echo "  bkp-pendrive <comando> [opções]"
    echo
    echo -e "\033[1mComandos:\033[0m"
    echo "  up, mount       Anexa e monta o dispositivo (auto-detecta)"
    echo "  down, unmount   Desmonta o dispositivo"
    echo "  status          Mostra status atual"
    echo "  list            Lista dispositivos USB (WSL + Windows)"
    echo "  attach <BUSID>  Anexa dispositivo específico do Windows ao WSL"
    echo "  check           Verifica integridade do ambiente"
    echo "  help            Mostra esta ajuda"
    echo
    echo -e "\033[1mOpções:\033[0m"
    echo "  --simulate      Modo simulação (sem hardware)"
    echo "  --force         Força desmontagem mesmo com processos ativos"
    echo "  --eject         Ejeta o dispositivo do WSL após desmontar"
    echo
    echo -e "\033[1mExemplo:\033[0m"
    echo "  bkp-pendrive up"
    echo "  ls $MOUNT_POINT"
    echo "  bkp-pendrive down"
}

# =========================
# Parse args
# =========================
COMMAND=""
BUSID_ARG=""
EXTRA_FLAGS=()
for arg in "$@"; do
    case "$arg" in
        --simulate)
            SIMULATE_MODE=true
            ;;
        --force|--eject)
            EXTRA_FLAGS+=("$arg")
            ;;
        *)
            if [ -z "$COMMAND" ]; then
                COMMAND="$arg"
            elif [ -z "$BUSID_ARG" ]; then
                BUSID_ARG="$arg"
            fi
            ;;
    esac
done

# =========================
# Commands
# =========================
cmd_up() {
    print_step "Iniciando montagem do pendrive..."
    
    if $SIMULATE_MODE; then
        log_info "[SIMULATE] Verificando usbipd-win..."
        log_info "[SIMULATE] Anexando USB ao WSL..."
        log_info "[SIMULATE] Detectando dispositivo USB..."
        log_success "[SIMULATE] Pendrive montado em $MOUNT_POINT"
        return 0
    fi
    
    # Check WSL
    check_wsl
    
    # Check/require usbipd
    if ! require_usbipd; then
        exit 1
    fi
    
    # Show available USB devices
    log_info "Dispositivos USB no Windows:"
    list_usb_devices
    echo
    
    # Try to detect if USB device is already in WSL
    log_info "Verificando dispositivo USB no WSL..."
    local device=""
    
    if [ -n "$PENDRIVE_LABEL" ]; then
        device=$(detect_device_by_label "$PENDRIVE_LABEL" || true)
    fi
    
    if [ -z "$device" ]; then
        device=$(detect_usb_device || true)
    fi
    
    # If not found, try to auto-attach from Windows
    if [ -z "$device" ]; then
        log_warn "Dispositivo nao encontrado no WSL."
        log_info "Tentando anexar automaticamente via usbipd..."
        
        # Find USB Mass Storage/UAS device in usbipd list and get its BUSID
        local busid
        busid=$(powershell.exe -NoProfile -Command "& '$USBIPD_EXE' list" 2>/dev/null | \
            grep -i "Mass Storage\|Armazenamento\|UAS\|SCSI" | \
            head -1 | \
            awk '{print $1}')
        
        if [ -n "$busid" ]; then
            log_info "Encontrado dispositivo USB (BUSID=$busid)"
            log_info "Anexando ao WSL..."
            
            # Try attach first (works if already bound)
            local attach_output
            attach_output=$(powershell.exe -NoProfile -Command "& '$USBIPD_EXE' attach --wsl --busid $busid" 2>&1 || true)
            
            if echo "$attach_output" | grep -qi "not shared\|bind"; then
                # Device needs to be bound first (requires admin)
                echo
                log_warn "Dispositivo precisa ser registrado (bind) no Windows."
                echo
                echo "=========================================="
                echo "  Execute no PowerShell como ADMIN:"
                echo ""
                echo "    usbipd bind --busid $busid"
                echo ""
                echo "  Apos executar, pressione ENTER..."
                echo "=========================================="
                read -r
                
                # Try attach again
                log_info "Tentando anexar novamente..."
                powershell.exe -NoProfile -Command "& '$USBIPD_EXE' attach --wsl --busid $busid" 2>&1
            fi
            
            # Wait a moment for device to appear (HDDs act slower than flash drives)
            sleep 5
            
            # Try detection again
            if [ -n "$PENDRIVE_LABEL" ]; then
                device=$(detect_device_by_label "$PENDRIVE_LABEL" || true)
            fi
            if [ -z "$device" ]; then
                device=$(detect_usb_device || true)
            fi
        fi
    fi
    
    if [ -z "$device" ]; then
        log_error "Nenhum dispositivo de armazenamento encontrado no WSL."
        log_warn "Verifique se há dispositivo conectado ao USB, troque a porta e tente novamente."
        echo
        log_info "Tente manualmente no PowerShell (Admin):"
        log_info "  usbipd list"
        log_info "  usbipd bind --busid <BUSID>"
        log_info "  usbipd attach --wsl --busid <BUSID>"
        exit 1
    fi
    
    log_success "Dispositivo detectado: $device"
    
    # Mount
    mount_ext4 "$device"
}

cmd_down() {
    print_step "Desmontando dispositivo..."
    
    if $SIMULATE_MODE; then
        log_info "[SIMULATE] Sincronizando dados..."
        log_info "[SIMULATE] Desmontando $MOUNT_POINT..."
        log_success "[SIMULATE] Dispositivo desmontado"
        return 0
    fi
    
    # Pass through any flags (--force, --eject)
    safe_unmount "${EXTRA_FLAGS[@]}"
}

cmd_status() {
    echo -e "\033[1mbkp-pendrive\033[0m v$VERSION"
    echo
    check_mount_status
    echo
    echo "Mount point: $MOUNT_POINT"
    [ -n "$PENDRIVE_LABEL" ] && echo "Label esperada: $PENDRIVE_LABEL"
}

# Attach a specific Windows USB device to WSL by BUSID
cmd_attach() {
    local busid="$1"
    
    if [ -z "$busid" ]; then
        log_error "BUSID não especificado"
        log_hint "Uso: bkp-pendrive attach <BUSID>"
        log_hint "Execute 'bkp-pendrive list' para ver os BUSIDs disponíveis"
        return 1
    fi
    
    print_step "Anexando dispositivo $busid ao WSL..."
    
    if ! require_usbipd; then
        return 1
    fi
    
    # Try to attach
    log_info "Executando: usbipd attach --wsl --busid $busid"
    
    local result
    result=$(powershell.exe -NoProfile -Command "& '$USBIPD_EXE' attach --wsl --busid $busid" 2>&1)
    
    if echo "$result" | grep -qi "error\|denied\|not shared"; then
        log_error "Falha ao anexar dispositivo"
        if echo "$result" | grep -qi "not shared"; then
            log_warn "Dispositivo precisa ser compartilhado primeiro"
            echo
            log_info "Execute no PowerShell como ADMIN:"
            echo -e "    ${BOLD}usbipd bind --busid $busid${NC}"
            echo
            log_info "Depois tente novamente: bkp-pendrive attach $busid"
        fi
        return 1
    fi
    
    # Wait for device to appear
    log_info "Aguardando dispositivo aparecer no WSL..."
    sleep 3
    
    log_success "Dispositivo $busid anexado ao WSL"
    log_hint "Execute 'bkp-pendrive list' para verificar"
    return 0
}

# =========================
# Main
# =========================
case "$COMMAND" in
    up|mount)
        cmd_up
        ;;
    down|unmount)
        cmd_down
        ;;
    status)
        cmd_status
        ;;
    list)
        # Disable set -e for device enumeration (grep may return 1 for empty results)
        set +e
        list_available_devices
        set -e
        ;;
    check)
        run_health_check
        ;;
    attach)
        cmd_attach "$BUSID_ARG"
        ;;
    help|"")
        show_help
        ;;
    *)
        log_error "Comando desconhecido: $COMMAND"
        show_help
        exit 1
        ;;
esac
